# igaming-balance-backend

## What is it?

See [task description](./docs/task.md).

## How to run it?

1. Run `docker compose up --build`
2. Open gRPC UI [http://localhost:8081](http://localhost:8081)
3. Use methods how you see fit
4. Or look at [client app](./cmd/client/main.go) logs

## How it works?

1. postgres - a persistent storage for balances and transactions
2. migrate - a tool for running database migrations before starting the main app
3. balance-app - the main service with gRPC + gRPC-Web + Connect
4. client - a simple client that periodically creates and cancels transactions
5. grpcui - a tool for executing gRPC requests against balance app

## How it was built?

1. Go - obvious choice
2. Buf - easy to use generator for gRPC server and client
    - popular
    - automatically installs protoc and all necessary plugins
    - can format, lint ProtoBuf schema and check changed schema for compatibility
    - can be installed via Go tools directive (see go.mod)
3. ConnectRPC - alternate gRPC backend
    - less boilerplate
    - has reflection API
    - has easy auto-setup for gRPC-Web
4. Sqlc - easy to use generator for type-safe SQL types and queries
    - popular
    - type-safe
    - very thin wrapper, pgx is used underhood
    - generated types can be customized to have custom types such as uuid.UUID and decimal.Decimal
    - can be installed via Go tools directive (see go.mod)
5. Mockery - generator for mocks
    - popular
    - works with generics
    - it just works (there is small difference between it and uber/mock)
6. golang-migrate - tool for running migrations
    - popular
    - it just works (there is no difference between it, goose and atlas with numbered migrations)
7. [UUID v7](https://uuid7.com/)
    - all pros of UUIDs
    - naturally sorted
    - optimized indexing
    - will be supported in the next version of PostgreSQL (18)
    - unfortunately not in PostgreSQL 17 yet :(
8. Advisory locks in PostgreSQL
    - quite fast
    - easy to use
    - versatile

## What needs to be done?

1. Better indices & query optimization
2. Tracing & metrics
3. More tests, especially integration tests
4. Configure pgx pooling
5. A lot of other stuff

## How to develop it?

1. Install Go 1.25
2. Run `go build ./...`
3. Run `go generate ./...` if you changed ProtoBuf or SQL schema

## More questions

Q: I open project and everything is in red squiggles

A: The repo uses the latest version of Go released ~2 weeks ago. There is a change you will have to update it.

---

Q: Why do I return errors when it is more accepted to return empty result with "OK" status?

A: I think clients should be responsible for handling situations when their modification request didn't actually modify anything. Clients can check error codes and distinguish between "completed successfully", "failed" and "failed because there is no work to do" on their own side and ignore or handle errors as necessary.

---

Q: Is this even gRPC?

A: Yes.

---

Q: Why it includes gRPC-Web, reflection API and other stuff no one asked for?

A: I wanted to have fun + reflection API is useful for clients + Buf docs have examples that have gRPC-Web enabled by default, so I decided not to change it.

---

Q: How long did it take to finish?

A: Probably 7-8 hours, I am not used to working with Buf and Sqlc.

---

Q: Why transactions don't have foreign keys for table with balances?

A: For flexibility & faster performance. Balance UUID inconsistency is not critical.

---

Q: Why UUID v7, not UUID vX, not INT/BIGINT?

A: UUID v7 are naturally sorted, can be easily generated by clients or different components in a distributed system. UUID before v7 are not suitable, after v7 don't exist yet.

---

Q: Our clients / external services don't work with UUID v7. What do we do?

A: We can use two tx IDs: one with external UUID and one with internal UUID v7. Current implementation is just a prototype and relies on clients providing valid UUID v7.

---

Q: Did I use any AI/LLM in this project?

A: Tests were fully generated by Claude Code and verified by me. Parts of Dockerfile, docker-compose.yml and some other files were written by Claude Code and heavily modified by me. Database is seeded with data generated by Claude Code as well.
